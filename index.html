<!DOCTYPE html>
<html lang="zh-TW">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>å°ç£è‡ªä¾†æ°´è²»è©¦ç®—ç³»çµ± - æ·±è‰²å„ªåŒ–ç‰ˆ</title>
	<style>
	      :root {
	        --primary-color: #2196F3;
	        --primary-dark: #1976D2;
	        --success-color: #4CAF50;
	        --danger-color: #f44336;
	        --bg-color: #f5f5f5;
	        --card-bg: white;
	        --text-color: #333;
	        --border-color: #e0e0e0;
            --input-bg: #fff;
            --highlight-bg: #fff176;
            --highlight-text: #000;
            --info-box-bg: #e3f2fd;
            --info-box-text: #0d47a1;
	      }

	      body {
	        font-family: Arial, "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
	        margin: 0;
	        padding: 20px;
	        background-color: var(--bg-color);
	        color: var(--text-color);
	        transition: background-color 0.3s ease, color 0.3s ease;
	      }

	      /* å¤§æ¨™é¡Œæ¨£å¼ */
	      .main-header {
	        text-align: center;
	        margin-bottom: 30px;
	        padding: 20px;
	        background: var(--card-bg);
	        border-radius: 8px;
	        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
	      }
	      
	      .main-header h1 {
	        margin: 0;
	        color: var(--primary-color);
	        font-size: 2.2em;
	      }

	      /* åº•éƒ¨èªªæ˜æ¬„æ¨£å¼ */
	      .main-footer {
	        text-align: center;
	        margin-top: 30px;
	        padding: 15px;
	        background: #e0e0e0;
	        border-radius: 8px;
	        color: #555;
	        font-weight: bold;
	      }
	      
	      .pending-tag {
	        border: 2px solid var(--danger-color);
	        color: var(--danger-color);
	        padding: 2px 6px;
	        border-radius: 4px;
	        margin-right: 5px;
	        display: inline-block;
            font-weight: bold;
	      }

	      /* ä¸‰æ¬„ä½ˆå±€å®¹å™¨ */
	      .grid-container {
	        display: grid;
	        grid-template-columns: 1fr 1fr 1fr;
	        gap: 20px;
	        max-width: 1600px;
	        margin: 0 auto;
	      }

	      @media (max-width: 1200px) {
	        .grid-container {
	          grid-template-columns: 1fr;
	        }
	      }

	      /* é€šç”¨å¡ç‰‡æ¨£å¼ */
	      .card {
	        background: var(--card-bg);
	        padding: 20px;
	        border-radius: 8px;
	        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
	        height: fit-content;
	        transition: background-color 0.3s ease;
	      }
	      
	      .card-title {
	        border-bottom: 2px solid var(--primary-color);
	        padding-bottom: 10px;
	        margin-bottom: 20px;
	        font-size: 1.3em;
	        color: var(--primary-color);
	        font-weight: bold;
	        text-align: center;
	      }

	      /* è¼¸å…¥æ¡†æ¨£å¼ */
	      .input-group { margin-bottom: 12px; }
	      label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.9em; }
	      select, input[type="number"], input[type="date"] {
	        width: 100%; padding: 8px; border: 1px solid var(--border-color);
	        border-radius: 4px; box-sizing: border-box; font-size: 1em;
            background-color: var(--input-bg);
            color: var(--text-color);
	      }
	      select:focus, input:focus {
	        border-color: var(--primary-color); outline: none;
	        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
	      }

	      /* æŒ‰éˆ•æ¨£å¼ */
	      .calculate-btn {
	        background-color: var(--success-color); color: white; width: 100%;
	        padding: 12px; border: none; border-radius: 4px; font-size: 1.1em;
	        cursor: pointer; margin-top: 15px; transition: background 0.3s;
	      }
	      .calculate-btn:hover { background-color: #45a049; }

	      /* --- çµæœé¡¯ç¤ºå€åŸŸé€šç”¨æ¨£å¼ --- */
	      .result-box { margin-top: 15px; }

          /* ç”¨æ–¼å·¦å³æ¬„çš„å…§éƒ¨å°ç™½å¡ */
          .bill-detail-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-left: 4px solid var(--primary-color);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
          }

          .bill-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 4px;
          }

          .bill-row.main { font-weight: bold; color: #333; font-size: 1.05em; }
          .bill-row.sub { font-size: 0.85em; color: #666; margin-top: 2px; }
          .bill-divider { border-top: 1px dashed #ccc; margin: 8px 0; }

          /* å³æ¬„å°ˆç”¨ï¼šé‹ç®—å¼æ¨£å¼ */
          .math-stack { text-align: right; font-size: 0.95em; }
          .math-stack .original { color: #888; text-decoration: line-through; font-size: 0.9em; }
          .math-stack .minus { color: var(--danger-color); }
          .math-stack .result { color: #000; font-weight: bold; font-size: 1.1em; border-top: 1px solid #ccc; padding-top: 2px; margin-top: 2px; display: inline-block;}

	      /* ä¸­æ¬„å°ˆç”¨è¡¨æ ¼ */
	      .calc-table {
	        width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em;
	      }
	      .calc-table th, .calc-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }
	      .calc-table th { background-color: #eee; font-size: 0.85em; }
	      
          /* è¡¨æ ¼é«˜äº®æ¨£å¼ (è®Šæ•¸åŒ–) */
          .calc-table .highlight-cell { 
              background-color: var(--highlight-bg); 
              color: var(--highlight-text);
              font-weight: bold; 
          }
          
          .section-divider { border-top: 2px dashed #bbb; margin: 15px 0; position: relative; }
          .section-divider span {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            background: var(--card-bg); padding: 0 10px; color: #777; font-size: 0.8em;
          }

	      .final-total {
	        background: #ffebee; color: #c62828; padding: 15px;
            border-radius: 8px; text-align: center; font-size: 1.3em;
            font-weight: bold; margin-top: 20px; border: 2px solid #ffcdd2;
	      }

          /* é‚è¼¯èªªæ˜å€å¡Š (è—è‰²) */
          .logic-info-box {
              background: var(--info-box-bg);
              color: var(--info-box-text);
              padding: 10px;
              border-radius: 4px;
              font-size: 0.85em;
              margin-bottom: 15px;
          }

	      .tooltip { position: relative; display: inline-block; cursor: pointer; font-size: 1.2em; color: #4CAF50; margin-left: 5px; }
	      .tooltip .tooltip-text {
	        visibility: hidden; width: 250px; background-color: #555; color: #fff;
	        text-align: center; border-radius: 6px; padding: 8px; position: absolute;
	        z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s;
	      }
	      .tooltip .tooltip-text::after {
	        content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
	        border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent;
	      }
	      .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }

	      /* =========================================
             ğŸŒ™ ç²¾ç·»æš—è‰²ä¸»é¡Œ (Dark Theme) å„ªåŒ–ç‰ˆ
             ========================================= */
	      body.dark-theme {
	        --bg-color: #121212;          /* æ›´æ·±çš„èƒŒæ™¯ï¼Œé¿å…ç´”é»‘æ­»æ¿ */
            --card-bg: #1e1e1e;           /* å¡ç‰‡æ·±ç° */
            --text-color: #e0e0e0;        /* æŸ”å’Œç™½ */
            --border-color: #333;         /* æ·±è‰²é‚Šæ¡† */
            --input-bg: #2c2c2c;          /* è¼¸å…¥æ¡†èƒŒæ™¯ */
            
            /* é«˜äº®è‰²èª¿æ•´ï¼šé¿å…æš—åº•ä¸Šå‡ºç¾åˆºçœ¼é»ƒ */
            --highlight-bg: rgba(255, 235, 59, 0.15); 
            --highlight-text: #fff9c4;
            
            /* è³‡è¨Šæ¡†èª¿æ•´ */
            --info-box-bg: #1a237e;       /* æ·±è—åº• */
            --info-box-text: #bbdefb;     /* æ·ºè—å­— */
	      }

          /* æš—è‰²æ¨¡å¼ - å¡ç‰‡èˆ‡é™°å½± */
          body.dark-theme .card { box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
          body.dark-theme .main-header { box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
          
          /* æš—è‰²æ¨¡å¼ - çµæœç´°ç¯€å¡ (Bill Detail Box) */
	      body.dark-theme .bill-detail-box { 
              background-color: #262626; 
              border-color: #444; 
              border-left-color: var(--primary-color); 
          }
          
          /* æš—è‰²æ¨¡å¼ - æ–‡å­—é¡è‰²ä¿®æ­£ */
          body.dark-theme .bill-row.main { color: #eee; }
          body.dark-theme .bill-row.sub { color: #aaa; }
          body.dark-theme .math-stack .original { color: #777; }
          body.dark-theme .math-stack .result { color: #fff; border-top-color: #555; }
          
          /* æš—è‰²æ¨¡å¼ - è¡¨æ ¼å„ªåŒ– */
          body.dark-theme .calc-table th { background-color: #333; color: #ddd; }
          body.dark-theme .calc-table td { border-color: #444; }
          /* æ–‘é¦¬ç´‹æ•ˆæœ */
          body.dark-theme .calc-table tr:nth-child(even) { background-color: rgba(255,255,255,0.03); }

          /* æš—è‰²æ¨¡å¼ - å¼·åˆ¶è¦†è“‹å…§è¯é¡è‰² (Inline Styles Override) */
          /* 1. å°‡åŸæœ¬ JS ç”¢ç”Ÿçš„æ·±è—è‰²/ç´…è‰²æ–‡å­—è½‰ç‚ºäº®è‰²ï¼Œå¢åŠ å¯è®€æ€§ */
          body.dark-theme span[style*="color:blue"], 
          body.dark-theme span[style*="color: blue"],
          body.dark-theme span[style*="color:#0d47a1"] { 
              color: #64b5f6 !important; 
          }
          
          body.dark-theme span[style*="color:red"],
          body.dark-theme span[style*="color: red"],
          body.dark-theme span[style*="color:#c62828"] { 
              color: #ff8a80 !important; 
          }

          /* 2. ç‰¹åˆ¥å„ªåŒ–ï¼šå‰ä¸€æœŸç¸½åº¦æ•¸ (åŸæœ¬æ˜¯æ·ºè—åº•+æ·±è—æ¡†) */
          body.dark-theme #prevTotalUsage {
              background-color: rgba(33, 150, 243, 0.15) !important; /* é€æ˜è— */
              border-color: #42a5f5 !important; /* äº®è—æ¡† */
              color: #fff !important;
              box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
          }

          /* 3. ç‰¹åˆ¥å„ªåŒ–ï¼šæ¸›å…å¤©æ•¸ (åŸæœ¬æ˜¯æ·ºç´…åº•+æ·±ç´…æ¡†) */
          body.dark-theme #reductionDays {
              background-color: rgba(244, 67, 54, 0.15) !important; /* é€æ˜ç´… */
              border-color: #ef5350 !important; /* äº®ç´…æ¡† */
              color: #fff !important;
              box-shadow: 0 0 5px rgba(244, 67, 54, 0.3);
          }

          /* 4. ç‰¹åˆ¥å„ªåŒ–ï¼šå‰ä¸€æœŸè²»ç”¨è©¦ç®—é»ƒè‰²å€å¡Š */
          body.dark-theme div[style*="background:#fffde7"] {
              background-color: rgba(255, 235, 59, 0.05) !important;
              border: 1px solid #444;
          }

          /* 5. æœ€çµ‚ç¸½è¨ˆå€å¡Š */
          body.dark-theme .final-total { 
              background-color: #3e2723; 
              color: #ffcdd2; 
              border-color: #5d4037; 
          }

          body.dark-theme .main-footer {
            background-color: #2c2c2c;
            color: #888;
          }
	</style>
</head>
<body>

	<div class="main-header">
		<h1>å°ç£è‡ªä¾†æ°´è²»è©¦ç®—ç³»çµ± <small style="font-size: 0.5em; opacity: 0.7;">(æ—¥æ¸›å…è©¦ç®—ç‰ˆ)</small></h1>
        <button onclick="document.body.classList.toggle('dark-theme')" style="padding: 6px 15px; cursor: pointer; border-radius: 20px; border: 1px solid #ccc; background: transparent; color: inherit; font-weight: bold;">ğŸŒ— åˆ‡æ›æ·±è‰²æ¨¡å¼</button>
	</div>

	<div class="grid-container">
		
        <div class="card">
			<div class="card-title">1. ç•¶æœŸåŸå§‹æ°´è²»</div>
			
			<div class="input-group">
				<label>ç”¨æ°´é¡åˆ¥ï¼š</label> 
				<select id="userType">
					<option value="normal">ä¸€èˆ¬ç”¨æ°´</option>
					<option value="military">è»çœ·ç”¨æ°´</option>
					<option value="municipal">å¸‚æ”¿ç”¨æ°´</option>
					<option value="Temporary">è‡¨æ™‚ç”¨æ°´(è¾²æ¥­ã€ç©ºåœ°)</option>
					<option value="illegal">é•ç« ç”¨æ°´(93)</option>
					<option value="discounted">å„ªæƒ ç”¨æ°´(åœ‹å°ã€åœ‹ä¸­)</option>
				</select>
			</div>
			
			<div class="input-group">
				<label>æ°´è¡¨å£å¾‘ï¼š</label> 
				<select id="meterSize">
					<option value="13">13mm</option>
					<option value="20">20mm</option>
					<option value="25" selected>25mm</option>
					<option value="40">40mm</option>
					<option value="50">50mm</option>
					<option value="75">75mm</option>
					<option value="100">100mm</option>
				</select>
			</div>

			<div class="input-group">
				<label>ç•¶æœŸå¯¦éš›ç”¨æ°´åº¦æ•¸ (åº¦)ï¼š</label> 
				<input id="waterUsage" type="number" min="0" step="1" placeholder="è¼¸å…¥ç•¶æœŸåº¦æ•¸" value="0">
			</div>

			<div class="input-group">
				<label>åˆ†æ”¤åº¦æ•¸ (åº¦)ï¼š</label> 
				<input id="sharedUsage" type="number" min="0" value="0">
			</div>
            
            <div class="input-group">
				<label>æ¸…é™¤è™•ç†è²»è²»ç‡ (å…ƒ/åº¦)ï¼š</label> 
				<input id="WasteDisposalRate" type="number" step="0.1" value="3.7">
				<span class="tooltip">â“ <span class="tooltip-text">æ¸…é™¤è™•ç†è²»åªè¨ˆç®—å¯¦éš›ç”¨æ°´åº¦æ•¸ï¼Œä¸åŒ…å«åˆ†æ”¤åº¦æ•¸</span></span>
			</div>
            
             <div class="input-group">
				<label>æ±¡æ°´ä¸‹æ°´é“ä½¿ç”¨è²»ç‡ (å…ƒ/åº¦)ï¼š</label> 
				<input id="SewageSewerRate" type="number" step="0.1" value="5">
				<span class="tooltip">â“ <span class="tooltip-text">æ±¡æ°´ä¸‹æ°´é“ä½¿ç”¨è²»è¨ˆç®—ï¼ŒåŒ…å«åˆ†æ”¤åº¦æ•¸</span></span>
			</div>

            <div class="input-group">
				<label>æ°´æºä¿è‚²èˆ‡å›é¥‹è²»ç‡ï¼š</label> 
				<select id="wrccfRate">
                    <option value="0">å…å¾µ</option>
                    <option value="0.05" selected>5%</option>
                    <option value="0.10">10%</option>
                </select>
			</div>
            
            <div class="input-group">
                <label>æŠ„è¡¨é »ç‡ï¼š</label>
                <select id="billingCycle">
                    <option value="bimonthly">éš”æœˆæŠ„è¡¨</option>
                    <option value="monthly">æ¯æœˆæŠ„è¡¨</option>
                </select>
            </div>

			<div id="resultLeft" class="result-box" style="display:none;"></div>
		</div>

        <div class="card">
			<div class="card-title">2. æ¸›å…æ°´è²»é¡åº¦</div>
            
            <div class="logic-info-box">
                <strong>é‚è¼¯èªªæ˜ï¼š</strong><br>
                1. <strong>åŸºæœ¬è²»</strong>ï¼šæ¡ã€Œå‰ä¸€æœŸåŸºæœ¬è²»ã€ç‚ºåŸºæº–ã€‚<br>
                2. <strong>ç”¨æ°´è²»</strong>ï¼šæ¡ã€Œå‰ä¸€æœŸç¸½åº¦æ•¸ã€ç®—å‡ºçš„è²»ç”¨ç‚ºåŸºæº–ã€‚<br>
 		    3.è¿‘ä¸€æœŸä¹‹ã€Œ<span style="color:red;"><strong>æ—¥å‡ç”¨æ°´è²»</span>ã€è¨ˆç®— ã€‚</strong><br>
                                           â†’ æ•…å…ˆã€Œ<span style="color:blue;">æ—¥å¹³å‡</span>ã€è²»ç”¨ï¼Œå†ä¹˜ä»¥ã€Œ<span style="color:blue;">æ¸›å…æ—¥æ•¸</span>ã€è¨ˆç®—ä¹‹ã€‚<br>
		    â†’ æœªç¨…ï¼Œè«‹å…ˆç®—åˆ°<span style="color:red;"><strong>æ•´æ•¸ä½</strong></span>)<br>
            </div>

			<div class="input-group">
				<label>å‰ä¸€æœŸç”¨æ°´å€é–“ (èµ·)ï¼š</label> 
				<input id="prevDateStart" type="date" value="2025-09-11">
			</div>
			
			<div class="input-group">
				<label>å‰ä¸€æœŸç”¨æ°´å€é–“ (è¨–)ï¼š</label> 
				<input id="prevDateEnd" type="date" value="2025-11-13">
			</div>
            
            <div class="input-group">
                <label>å‰ä¸€æœŸç¸½åº¦æ•¸ (å«åˆ†æ”¤)ï¼š</label>
                <input id="prevTotalUsage" type="number" min="0" value="46" style="border: 2px solid #1f1bf5; background-color: #e3f2fd;">
            </div>

			<div class="input-group">
				<label>æ¸›å…å¤©æ•¸ (æ—¥)ï¼š</label> 
                <input id="reductionDays" type="number" min="0" value="15" style="border: 2px solid #f32121; background-color: #fde5e3;">
			</div>

			<button class="calculate-btn" onclick="calculateAll()">é–‹å§‹è©¦ç®—</button>

			<div id="resultMiddle" class="result-box" style="display:none;"></div>
		</div>

        <div class="card">
			<div class="card-title">3. æœ€çµ‚æ°´è²»å¸³å–®</div>
			
			<div id="resultRight" class="result-box" style="display:none;">
				<p style="text-align:center; padding: 20px; opacity: 0.6;">è«‹å…ˆé»æ“Šä¸­é–“çš„ã€Œé–‹å§‹è©¦ç®—ã€</p>
			</div>
		</div>

	</div>

	<div class="main-footer">
		<span class="pending-tag">ã€å¾…è£œã€‘</span> ã€‚
	</div>

	<script>
        // --- åŸºç¤æ•¸æ“šå®šç¾© (æ²¿ç”¨åŸç‰ˆ) ---
        const baseFeeTable = {
            "13": 34, "20": 68, "25": 126, "40": 374, "50": 680,
            "75": 1836, "100": 3638, "150": 10098, "200": 20060,
            "250": 35428, "300": 55590
        };
        const normalRatesMonthly = [
            { range: [1, 10], price: 7 }, { range: [11, 30], price: 9 },
            { range: [31, 50], price: 11 }, { range: [51, Infinity], price: 11.5 }
        ];
        const normalRatesBimonthly = [
            { range: [1, 20], price: 7 }, { range: [21, 60], price: 9 },
            { range: [61, 100], price: 11 }, { range: [101, Infinity], price: 11.5 }
        ];
        const userTypes = {
            normal: { label: "ä¸€èˆ¬ç”¨æ°´", baseFeeDiscount: 1, waterFeeDiscount: 1 },
            military: { label: "è»çœ·ç”¨æ°´", baseFeeDiscount: 0.5, waterFeeDiscount: "first40half" },
            municipal: { label: "å¸‚æ”¿ç”¨æ°´", baseFeeDiscount: 0.5, waterFeeDiscount: 0.5 },
            Temporary: { label: "è‡¨æ™‚ç”¨æ°´", baseFeeDiscount: 1.5, waterFeeDiscount: 1.5 },
            illegal: { label: "é•ç« ç”¨æ°´", baseFeeDiscount: 1.2, waterFeeDiscount: 1.2 },
            discounted: { label: "å„ªæƒ ç”¨æ°´", baseFeeDiscount: 1, waterFeeFlatRate: 7 }
        };

        function formatMoney(amount) {
            return amount.toLocaleString("zh-TW", { style: "currency", currency: "TWD", minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function roundTwo(num) {
            return Math.round((num + Number.EPSILON) * 100) / 100;
        }

        // --- ä¸»è¨ˆç®—æ§åˆ¶å™¨ ---
        function calculateAll() {
            const leftData = calculateOriginalBill();
            if (!leftData) return; 
            
            renderLeftColumn(leftData);
            const middleData = calculateReduction(leftData);
            renderMiddleColumn(middleData);
            renderRightColumn(leftData, middleData);
            
            document.getElementById('resultLeft').style.display = 'block';
            document.getElementById('resultMiddle').style.display = 'block';
            document.getElementById('resultRight').style.display = 'block';
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—å–®ç´”çš„ç”¨æ°´è²» ---
        function calculatePureWaterFee(totalUsage, userTypeKey, isMonthly) {
            const userType = userTypes[userTypeKey];
            let rawRates = isMonthly ? normalRatesMonthly : normalRatesBimonthly;
            let waterRates;

            if (userType.waterFeeFlatRate !== undefined) {
                waterRates = [{ range: [1, Infinity], price: userType.waterFeeFlatRate, military: false }];
            } else if (userType.waterFeeDiscount === "first40half") {
                waterRates = getMilitaryRates(rawRates, isMonthly);
            } else {
                waterRates = rawRates.map(r => ({
                    ...r,
                    price: r.price * userType.waterFeeDiscount,
                    military: false
                }));
            }

            let fee = 0;
            let breakdown = [];
            let remaining = totalUsage;
            
            for (const { range, price, military } of waterRates) {
                const [min, max] = range;
                if (totalUsage >= min) {
                    const usageInTier = Math.min(remaining, (max === Infinity ? remaining : (max - min + 1)));
                    const tierFee = usageInTier * price;
                    breakdown.push({
                        range: `${min}-${max === Infinity ? "ä»¥ä¸Š" : max}åº¦`,
                        usage: usageInTier,
                        rate: price,
                        fee: tierFee,
                        military
                    });
                    fee += tierFee;
                    remaining -= usageInTier;
                    if (remaining <= 0) break;
                }
            }
            return { fee, breakdown, rates: rawRates };
        }

        // --- é‚è¼¯ï¼šè¨ˆç®—å·¦å€å¡Š ---
        function calculateOriginalBill() {
            const meterSize = document.getElementById("meterSize").value;
            const realUsage = parseFloat(document.getElementById("waterUsage").value) || 0;
            const sharedUsage = parseFloat(document.getElementById("sharedUsage").value) || 0;
            const totalUsage = realUsage + sharedUsage;
            const userTypeKey = document.getElementById("userType").value;
            const userType = userTypes[userTypeKey];
            const billingCycle = document.getElementById("billingCycle").value;
            const isMonthly = billingCycle === "monthly";
            
            const WDR = parseFloat(document.getElementById("WasteDisposalRate").value) || 0;
            const SSR = parseFloat(document.getElementById("SewageSewerRate").value) || 0;
            const wrccfRate = parseFloat(document.getElementById("wrccfRate").value) || 0;

            let baseFeeOriginal = baseFeeTable[meterSize];
            let baseFee = baseFeeOriginal * userType.baseFeeDiscount;
            if (isMonthly) baseFee *= 0.5;
            const baseTax = baseFee * 0.05;

            const waterCalcs = calculatePureWaterFee(totalUsage, userTypeKey, isMonthly);
            const waterFee = waterCalcs.fee;
            const waterTax = waterFee * 0.05;

            const unDiscountedWaterFee = calculateUnDiscountedFee(totalUsage, waterCalcs.rates);
            const WRCCF = Math.round(unDiscountedWaterFee * wrccfRate);
            const WDT = Math.round(realUsage * WDR);
            const SST = Math.round(totalUsage * SSR);
            
            return {
    			baseFee, baseTax, waterFee, waterTax,
    			WDT, SST, WRCCF,
   			breakdown: waterCalcs.breakdown,
    			totalUsage,
   			userTypeLabel: userType.label,
    			meterSize,
    			userTypeKey,
    			isMonthly,
   			realUsage,
    			unDiscountedWaterFee,
    			WDR,
    			SSR
            };
        }

        // --- é‚è¼¯ï¼šè¨ˆç®—ä¸­å€å¡Š ---
        function calculateReduction(currentBill) {
            const dateStart = new Date(document.getElementById("prevDateStart").value);
            const dateEnd = new Date(document.getElementById("prevDateEnd").value);
            const reductionDaysInput = parseInt(document.getElementById("reductionDays").value) || 0;
            const prevTotalUsage = parseFloat(document.getElementById("prevTotalUsage").value) || 0;
            
            const timeDiff = dateEnd.getTime() - dateStart.getTime();
            const periodDays = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
            
            if (periodDays <= 0 || isNaN(periodDays)) {
                alert("æ—¥æœŸè¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å‰ä¸€æœŸå€é–“");
                return null;
            }

            const dailyAvgBase = roundTwo(currentBill.baseFee / periodDays);
            const reductionBasePreTax = Math.round(dailyAvgBase * reductionDaysInput); 
            const reductionBaseIncTax = roundTwo(reductionBasePreTax * 1.05);

            const prevWaterCalcs = calculatePureWaterFee(prevTotalUsage, currentBill.userTypeKey, currentBill.isMonthly);
            const prevWaterFee = prevWaterCalcs.fee; 

            const dailyAvgWater = roundTwo(prevWaterFee / periodDays);
            const reductionWaterPreTax = Math.round(dailyAvgWater * reductionDaysInput);
            const reductionWaterIncTax = roundTwo(reductionWaterPreTax * 1.05);
            
            return {
		    baseFee: currentBill.baseFee,
                periodDays, reductionDaysInput,
                dateStr: `${formatDate(dateStart)} - ${formatDate(dateEnd)}`,
                prevTotalUsage, prevWaterFee, 
                prevBreakdown: prevWaterCalcs.breakdown,
                base: { daily: dailyAvgBase, preTax: reductionBasePreTax, incTax: reductionBaseIncTax },
                water: { daily: dailyAvgWater, preTax: reductionWaterPreTax, incTax: reductionWaterIncTax }
            };
        }

        // --- æ¸²æŸ“ï¼šå·¦æ¬„ (Unified Style) ---
        function renderLeftColumn(data) {
            const totalFee = Math.round(data.baseFee + data.baseTax + data.waterFee + data.waterTax + data.WDT + data.WRCCF + data.SST);
            
            const html = `
                <div class="bill-detail-box">
                    <div class="bill-row main">
                        <span>åŸºæœ¬è²»</span>
                        <span>${data.baseFee} å…ƒ</span>
                    </div>
                    <div class="bill-row sub">
                        <span>ç‡Ÿæ¥­ç¨…</span>
                        <span>${roundTwo(data.baseTax)} å…ƒ</span>
                    </div>
                </div>
                
                <div class="bill-detail-box">
                    <div class="bill-row main" style="margin-bottom:8px;">
                        <span>ç”¨æ°´è²» <small style="font-weight:normal; opacity:0.7;">(ç¸½åº¦æ•¸ ${data.totalUsage})</small></span>
                        <span>${data.waterFee} å…ƒ</span>
                    </div>
                    
                    ${data.breakdown.map(item => `
                        <div class="bill-row sub" style="margin-bottom:2px;">
                            <span>â–ª ${item.range}</span>
                            <span>${item.usage}åº¦ Ã— ${item.rate} = ${Math.round(item.fee)}</span>
                        </div>
                    `).join('')}
                    
                    <div class="bill-divider"></div>
                    <div class="bill-row sub">
                        <span>ç‡Ÿæ¥­ç¨…</span>
                        <span>${roundTwo(data.waterTax)} å…ƒ</span>
                    </div>
                </div>
                
                <div class="bill-detail-box" style="border-left-color: #607d8b;">
                    <div class="bill-row main" style="color: #607d8b;">
                        <span>ä»£å¾µè²»ç”¨</span>
                        <span>${data.WDT + data.WRCCF + data.SST} å…ƒ</span>
                    </div>
                    <div class="bill-divider"></div>
                    <div class="bill-row sub">
                        <span>æ¸…é™¤è™•ç†è²»ï¼ˆä¸å«åˆ†æ”¤åº¦æ•¸ï¼‰:  ${data.WDR} Ã— ${document.getElementById("waterUsage").value}åº¦</span>
                        <span>${data.WDT} å…ƒ</span>
                    </div>
                    <div class="bill-row sub">
                        <span>æ°´æºä¿è‚²è²»:  ${data.unDiscountedWaterFee} Ã— ${document.getElementById("wrccfRate").selectedOptions[0].text}</span>
                        <span>${data.WRCCF} å…ƒ</span>
                    </div>
                    <div class="bill-row sub">
                        <span>æ±¡æ°´ä¸‹æ°´é“ä½¿ç”¨è²»ï¼ˆç¸½ç”¨æ°´åº¦æ•¸ï¼‰ï¼š ${data.SSR} Ã— ${data.totalUsage}åº¦</span>
                        <span>${data.SST} å…ƒ</span>
                    </div>
                </div>
                
                <div class="final-total">
                    åŸå§‹ç¸½è¨ˆï¼š${formatMoney(totalFee)}
                </div>
            `;
            document.getElementById('resultLeft').innerHTML = html;
        }

        // --- æ¸²æŸ“ï¼šä¸­æ¬„ (Keep logic, just minor text fix) ---
        function renderMiddleColumn(data) {
            if (!data) return;
            
            const html = `
                <div class="breakdown-item">
                    <strong>1. ç”¨æ°´å¤©æ•¸è¨ˆç®—ï¼š</strong><br>
                    ${data.dateStr} = <span style="color:blue; font-weight:bold;">${data.periodDays}</span> æ—¥
                </div>

                <div class="section-divider"><span>å‰ä¸€æœŸè²»ç”¨è©¦ç®—</span></div>

                <div class="breakdown-item" style="background:#fffde7; padding: 10px; border-radius:4px;">
                    <strong>å‰ä¸€æœŸç”¨æ°´è²» (åº¦æ•¸ ${data.prevTotalUsage})ï¼š</strong>
                    <div style="font-size:0.85em; opacity:0.8;">
                    ${data.prevBreakdown.map(item => `
                        ${item.range}ï¼š${item.usage}åº¦ Ã— ${item.rate}å…ƒ = ${Math.round(item.fee)}<br>
                    `).join('')}
                    <strong style="display:block; margin-top:5px;">åˆè¨ˆï¼š${data.prevWaterFee} å…ƒ</strong>
                    </div>
                </div>
                
                <div class="section-divider"><span>æ¸›å…é¡åº¦è¨ˆç®—</span></div>

                <table class="calc-table">
                    <caption><strong>åŸºæœ¬è²»æ¸›å…</strong></caption>
                    <tr><th>é …ç›®</th><th>æ•¸å€¼</th><th>å‚™è¨»</th></tr>
                    <tr><td>æ—¥å¹³å‡~æœªç¨…(A)</td><td>${data.base.daily}</td><td><span style="color:blue;">åŸºæœ¬è²»${data.baseFee}</span>/ ${data.periodDays}</td></tr>
                    <tr class="highlight-cell"><td>æ¸›å…é¡(æœªç¨…)</td><td>${data.base.preTax}</td><td>A Ã— <span  style="color:red;">${data.reductionDaysInput}</span>å¤©</td></tr>
                    <tr><td>å«ç¨…é‡‘é¡</td><td style="color:red; font-weight:bold;">${data.base.incTax}</td><td>Ã— 1.05</td></tr>
                </table>
                
                <table class="calc-table">
                    <caption><strong>ç”¨æ°´è²»æ¸›å…</strong></caption>
                    <tr><th>é …ç›®</th><th>æ•¸å€¼</th><th>å‚™è¨»</th></tr>
                    <tr><td>æ—¥å¹³å‡~æœªç¨…(A)</td><td>${data.water.daily}</td><td><span style="color:blue;">å‰æœŸæ°´è²»${data.prevWaterFee}</span> / ${data.periodDays}</td></tr>
                    <tr class="highlight-cell"><td>æ¸›å…é¡(æœªç¨…)</td><td>${data.water.preTax}</td><td>A Ã— <span  style="color:red;">${data.reductionDaysInput}å¤©</span></td></tr>
                    <tr><td>å«ç¨…é‡‘é¡</td><td style="color:red; font-weight:bold;">${data.water.incTax}</td><td>Ã— 1.05</td></tr>
                </table>
            `;
            document.getElementById('resultMiddle').innerHTML = html;
        }

        // --- æ¸²æŸ“ï¼šå³æ¬„ (Unified Style) ---
        function renderRightColumn(orig, red) {
            if (!red) return;

            const finalBase = (orig.baseFee + orig.baseTax) - red.base.incTax;
            const finalWater = (orig.waterFee + orig.waterTax) - red.water.incTax;
            const levies = orig.WDT + orig.WRCCF + orig.SST;
            
            const finalTotal = roundTwo(finalBase + finalWater + levies);

            const html = `
                <div class="bill-detail-box">
                    <div class="bill-row main">
                        <span>åŸºæœ¬è²» (æ¸›å…å¾Œ)</span>
                    </div>
                    <div class="math-stack">
                        <div >åŸå§‹(å«ç¨…)ï¼š${formatMoney(orig.baseFee + roundTwo(orig.baseTax))}</div>
                        <div class="minus">- æ¸›å…ï¼š${formatMoney(red.base.incTax)}</div>
                        <div class="result">${formatMoney(roundTwo(finalBase))}</div>
                    </div>
                </div>

                <div class="bill-detail-box">
                    <div class="bill-row main">
                        <span>ç”¨æ°´è²» (æ¸›å…å¾Œ)</span>
                    </div>
                    <div class="math-stack">
                        <div >åŸå§‹(å«ç¨…)ï¼š${formatMoney(orig.waterFee + roundTwo(orig.waterTax))}</div>
                        <div class="minus">- æ¸›å…ï¼š${formatMoney(red.water.incTax)}</div>
                        <div class="result">${formatMoney(roundTwo(finalWater))}</div>
                    </div>
                </div>

                <div class="bill-detail-box" style="border-left-color: #607d8b;">
                    <div class="bill-row main">
                        <span>ä»£å¾µè²»ç”¨ (ç„¡è®Šå‹•)</span>
                    </div>
                    <div class="math-stack">
                         <div style="font-size:0.9em; margin-bottom:2px;">
                            (æ¸…é™¤${orig.WDT} + ä¿è‚²${orig.WRCCF} + æ±¡æ°´${orig.SST})
                         </div>
                         <div class="result">${formatMoney(levies)}</div>
                    </div>
                </div>

                <div class="final-total">
                    æ‡‰ç¹³ç¸½é‡‘é¡ï¼š${formatMoney(finalTotal)}
                </div>
            `;
            document.getElementById('resultRight').innerHTML = html;
        }

        // --- è¼”åŠ©å‡½æ•¸ ---
        function formatDate(date) { return `${date.getMonth()+1}/${date.getDate()}`; }
        function calculateUnDiscountedFee(totalUsage, rates) {
            let fee = 0; let remaining = totalUsage;
            for (const { range, price } of rates) {
                const [min, max] = range;
                if (totalUsage >= min) {
                    const usage = Math.min(remaining, (max === Infinity ? remaining : max - min + 1));
                    fee += usage * price; remaining -= usage;
                    if (remaining <= 0) break;
                }
            } return fee;
        }
        function getMilitaryRates(rates, isMonthly) {
            const halfPriceLimit = isMonthly ? 20 : 40; let accumulatedUsage = 0; const result = [];
            for (const { range, price } of rates) {
                const [min, max] = range;
                if (accumulatedUsage < halfPriceLimit) {
                    const startRange = min; const remainingHalfPrice = halfPriceLimit - accumulatedUsage;
                    const rangeSize = max === Infinity ? Infinity : max - min + 1;
                    const halfPriceUsage = Math.min(remainingHalfPrice, rangeSize);
                    if (halfPriceUsage > 0) {
                        result.push({ range: [startRange, startRange + halfPriceUsage - 1], price: price / 2, military: true });
                        accumulatedUsage += halfPriceUsage;
                    }
                    if (max !== Infinity && startRange + halfPriceUsage - 1 < max) {
                        result.push({ range: [startRange + halfPriceUsage, max], price: price, military: false });
                    }
                } else { result.push({ range: [min, max], price: price, military: false }); }
            } return result;
        }
	</script>
</body>
</html>
